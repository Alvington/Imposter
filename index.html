<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMPOSTER GAME | Social Deduction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --accent: #ef4444;
            --bg: #020617;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: #f8fafc; 
            margin: 0; 
            min-height: 100vh; 
            overflow-x: hidden; 
            background-image: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #020617 100%);
        }
        h1, .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #312e81; border-radius: 10px; }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(99, 102, 241, 0.1);
            animation: scanline 8s linear infinite;
            pointer-events: none; z-index: 50;
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        .animate-glitch { animation: glitch 0.2s ease-in-out infinite; }
        
        .glass-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        input[type="range"] { -webkit-appearance: none; background: transparent; }
        input[type="range"]::-webkit-slider-runnable-track { background: #1e293b; height: 6px; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: var(--primary); margin-top: -6px; border: 2px solid #fff; cursor: pointer; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .pulse-red { animation: pulse-red 2s infinite; }
    </style>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "@google/genai": "https://esm.sh/@google/genai@1.34.0",
        "lucide-react": "https://esm.sh/lucide-react@0.460.0"
      }
    }
    </script>
</head>
<body>
    <div class="scanline"></div>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI } from "@google/genai";
        import * as Lucide from 'lucide-react';

        const Role = { CIVILIAN: 'CIVILIAN', IMPOSTER: 'IMPOSTER' };
        const GameState = { 
            MODE: 'MODE', 
            SETUP: 'SETUP', 
            MANUAL_JOIN: 'MANUAL_JOIN',
            SHARE: 'SHARE',
            JOIN: 'JOIN',
            CONFIRM: 'CONFIRM', 
            REVEAL: 'REVEAL', 
            PLAYING: 'PLAYING', 
            VOTED_REVEAL: 'VOTED_REVEAL',
            WINNER: 'WINNER'
        };
        
        const CATEGORIES = ["Silly & Random", "Christmas", "Bible", "Cyberpunk", "Space", "Ancient History", "Food", "Movies", "Gaming", "Undercover", "Science", "Animals", "Pop Culture"];

        const utoa = (str) => {
            try {
                const bytes = new TextEncoder().encode(str);
                let binString = "";
                for (let i = 0; i < bytes.byteLength; i++) {
                    binString += String.fromCharCode(bytes[i]);
                }
                return btoa(binString);
            } catch (e) {
                console.error("utoa error", e);
                return "";
            }
        };

        const atou = (base64) => {
            try {
                const binString = atob(base64);
                const bytes = Uint8Array.from(binString, (m) => m.charCodeAt(0));
                return new TextDecoder().decode(bytes);
            } catch (e) {
                console.error("atou error", e);
                throw e;
            }
        };

        const Icon = ({ name, ...props }) => {
            const LucideIcon = Lucide[name];
            return LucideIcon ? <LucideIcon {...props} /> : null;
        };

        const App = () => {
            const [view, setView] = useState(GameState.MODE);
            const [isOnline, setIsOnline] = useState(false);
            const [loading, setLoading] = useState(false);
            const [players, setPlayers] = useState([]);
            const [gameData, setGameData] = useState(null);
            const [currentPlayerIdx, setCurrentPlayerIdx] = useState(0);
            const [isSecretVisible, setIsSecretVisible] = useState(false);
            const [winner, setWinner] = useState(null);
            const [votedPlayer, setVotedPlayer] = useState(null);
            const [timeLeft, setTimeLeft] = useState(180);
            const [duration, setDuration] = useState(3); 
            const [numPlayers, setNumPlayers] = useState(4);
            const [numImposters, setNumImposters] = useState(1);
            const [category, setCategory] = useState("Silly & Random");
            const [playerNames, setPlayerNames] = useState(["", "", "", ""]);
            const [roomCode, setRoomCode] = useState("");
            const [showLinkFallback, setShowLinkFallback] = useState(false);
            const [manualKey, setManualKey] = useState("");

            useEffect(() => {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const dataParam = urlParams.get('data');
                    if (dataParam) {
                        loadFromEncodedData(dataParam);
                    }
                } catch (e) {
                    console.error("URL params error", e);
                }
            }, []);

            const loadFromEncodedData = (encodedData) => {
                try {
                    const cleanEncoded = decodeURIComponent(encodedData.trim());
                    const decodedStr = atou(cleanEncoded);
                    const decoded = JSON.parse(decodedStr);
                    
                    if (!decoded.gameData || !decoded.players) {
                        throw new Error("Invalid structure");
                    }

                    setGameData(decoded.gameData);
                    setPlayers(decoded.players);
                    setDuration(decoded.duration || 3);
                    setRoomCode(decoded.roomCode || "UNKNOWN");
                    setIsOnline(true);
                    setView(GameState.JOIN);
                } catch (e) {
                    console.error("Neural Key corruption error:", e);
                    alert("Neural Key Corrupted or Invalid. Please ensure you copied the full key or link.");
                }
            };

            const safeResetURL = () => {
                try {
                    if (window.history && window.history.pushState) {
                        window.history.pushState({}, '', window.location.pathname);
                    }
                } catch (e) {
                    console.warn("Could not reset URL history due to security restrictions", e);
                }
            };

            useEffect(() => {
                let timer;
                if (view === GameState.PLAYING && timeLeft > 0) {
                    timer = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
                }
                return () => clearInterval(timer);
            }, [view, timeLeft]);

            const generateRoomCode = () => {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            };

            const getEncodedState = (data, playerList, code) => {
                const state = {
                    gameData: data,
                    players: playerList,
                    duration: duration,
                    roomCode: code
                };
                return utoa(JSON.stringify(state));
            };

            const getShareableLink = (encoded) => {
                try {
                    const origin = window.location.origin || "";
                    const pathname = window.location.pathname || "/";
                    return `${origin}${pathname}?data=${encodeURIComponent(encoded)}`;
                } catch (e) {
                    return `?data=${encodeURIComponent(encoded)}`;
                }
            };

            const startNewGame = async () => {
                setLoading(true);
                try {
                    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                    const prompt = `Imposter Game Logic:
                    Category: ${category}
                    Instructions: 
                    1. Generate a secret word for Civilians.
                    2. Generate a related but distinct cryptic hint for the Imposter.
                    3. Generate a 1-sentence "Mission Lore" snippet.
                    Return valid JSON: { "word": "...", "hint": "...", "lore": "..." }`;
                    
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: prompt,
                        config: { responseMimeType: "application/json" }
                    });
                    const data = JSON.parse(response.text);
                    setupPlayers(data);
                } catch (e) {
                    console.error("AI Error:", e);
                    setupPlayers({ 
                        word: "Infiltrator", 
                        hint: "Someone inside who shouldn't be.", 
                        lore: "An unknown signal has been detected within the perimeter." 
                    });
                } finally {
                    setLoading(false);
                }
            };

            const setupPlayers = (data) => {
                const names = playerNames.map((n, i) => n.trim() || `Agent ${i+1}`);
                const roles = [...Array(numImposters).fill(Role.IMPOSTER), ...Array(names.length - numImposters).fill(Role.CIVILIAN)];
                roles.sort(() => Math.random() - 0.5);

                const finalPlayers = names.map((name, i) => ({
                    id: i,
                    name,
                    role: roles[i],
                    secret: roles[i] === Role.CIVILIAN ? data.word : data.hint
                }));

                setGameData(data);
                setPlayers(finalPlayers);
                setCurrentPlayerIdx(0);
                setIsSecretVisible(false);
                setTimeLeft(duration * 60);
                setVotedPlayer(null);

                if (isOnline) {
                    const code = generateRoomCode();
                    setRoomCode(code);
                    setView(GameState.SHARE);
                } else {
                    setView(GameState.CONFIRM);
                }
            };

            const handleRevealDone = () => {
                setIsSecretVisible(false);
                if (isOnline) {
                    setView(GameState.PLAYING);
                } else {
                    if (currentPlayerIdx < players.length - 1) {
                        setCurrentPlayerIdx(prev => prev + 1);
                        setView(GameState.CONFIRM);
                    } else {
                        setView(GameState.PLAYING);
                    }
                }
            };

            const copyToClipboard = async (text) => {
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(text);
                        alert("Mission link copied to clipboard!");
                    } else {
                        setShowLinkFallback(true);
                    }
                } catch (err) {
                    console.error("Clipboard Error", err);
                    setShowLinkFallback(true);
                }
            };

            const handleManualJoin = () => {
                let input = manualKey.trim();
                if (!input) return;

                let key = input;
                if (input.includes("data=")) {
                    try {
                        if (input.startsWith('http')) {
                            const url = new URL(input);
                            const params = new URLSearchParams(url.search);
                            key = params.get('data') || key;
                        } else if (input.includes("?data=")) {
                            key = input.split("?data=")[1].split("&")[0];
                        }
                    } catch (e) {
                        console.error("Manual join key parsing error", e);
                    }
                }
                
                loadFromEncodedData(key);
            };

            const BackButton = ({ to, onClick }) => (
                <button 
                    onClick={() => {
                        if (onClick) onClick();
                        setView(to);
                    }}
                    className="absolute left-6 top-6 p-2 rounded-full bg-slate-900/50 border border-slate-800 hover:border-indigo-500 transition-all text-slate-400 hover:text-indigo-400 z-10"
                >
                    <Icon name="ArrowLeft" className="w-5 h-5" />
                </button>
            );

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-950 p-6 text-center">
                    <div className="relative w-32 h-32 mb-10">
                        <div className="absolute inset-0 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                        <div className="absolute inset-4 border-4 border-red-500 border-b-transparent rounded-full animate-spin" style={{animationDirection: 'reverse', animationDuration: '1.5s'}}></div>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <Icon name="Cpu" className="w-8 h-8 text-indigo-400 animate-pulse" />
                        </div>
                    </div>
                    <p className="font-orbitron text-indigo-400 font-bold uppercase tracking-[0.4em] mb-2">Neural Synthesis...</p>
                    <p className="text-slate-500 text-xs font-bold uppercase tracking-widest animate-pulse">Forging Mission Lore</p>
                </div>
            );

            return (
                <div className="w-full min-h-screen flex flex-col items-center p-4 md:p-8 overflow-y-auto custom-scrollbar">
                    <header className="mb-8 text-center animate-fade-in relative">
                        <h1 className="text-5xl md:text-7xl font-black text-white italic tracking-tighter drop-shadow-[0_0_15px_rgba(99,102,241,0.5)]">
                            IMPOSTER GAME
                        </h1>
                        <div className="flex items-center justify-center gap-4 mt-4">
                            <span className="h-px w-8 bg-indigo-500/30"></span>
                            <p className="text-indigo-400 text-[10px] font-bold uppercase tracking-[0.6em]">FUN INTELLIGENCE GAME</p>
                            <span className="h-px w-8 bg-indigo-500/30"></span>
                        </div>
                    </header>

                    <main className="w-full max-w-lg flex flex-col items-stretch relative">
                        {view === GameState.MODE && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => { setIsOnline(true); setView(GameState.SETUP); }} className="group glass-card p-6 md:p-8 rounded-[2rem] border-b-4 border-indigo-900 hover:translate-y-1 hover:border-b-2 transition-all flex flex-col items-center gap-4">
                                        <div className="p-4 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-500/50 group-hover:scale-110 transition-transform">
                                            <Icon name="Plus" className="w-8 h-8 text-white" />
                                        </div>
                                        <span className="font-orbitron text-sm md:text-base font-bold text-white uppercase text-center">New Mission</span>
                                    </button>
                                    
                                    <button onClick={() => setView(GameState.MANUAL_JOIN)} className="group glass-card p-6 md:p-8 rounded-[2rem] border-b-4 border-indigo-500/20 hover:translate-y-1 hover:border-b-2 transition-all flex flex-col items-center gap-4">
                                        <div className="p-4 bg-indigo-900/40 rounded-2xl group-hover:scale-110 transition-transform border border-indigo-500/30">
                                            <Icon name="Key" className="w-8 h-8 text-indigo-400" />
                                        </div>
                                        <span className="font-orbitron text-sm md:text-base font-bold text-indigo-400 uppercase text-center">Join Mission</span>
                                    </button>
                                </div>

                                <button onClick={() => { setIsOnline(false); setView(GameState.SETUP); }} className="group glass-card p-6 rounded-[2rem] border-b-4 border-slate-900 hover:translate-y-1 hover:border-b-2 transition-all flex flex-col items-center gap-2 w-full">
                                    <span className="text-slate-500 font-bold uppercase tracking-widest text-[10px]">Offline Mode</span>
                                    <div className="flex items-center gap-3">
                                        <Icon name="Gamepad2" className="w-5 h-5 text-slate-400" />
                                        <span className="font-orbitron text-base font-bold text-slate-400 uppercase">Pass & Play</span>
                                    </div>
                                </button>
                            </div>
                        )}

                        {view === GameState.MANUAL_JOIN && (
                            <div className="glass-card p-10 rounded-[3rem] text-center space-y-8 animate-fade-in border-t-4 border-indigo-500 relative">
                                <BackButton to={GameState.MODE} />
                                <div className="space-y-2 pt-6">
                                    <h2 className="text-indigo-400 font-orbitron font-bold text-xl uppercase">Neural Uplink</h2>
                                    <p className="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Enter Neural Key or Mission Link</p>
                                </div>
                                <div className="space-y-4">
                                    <textarea 
                                        placeholder="Paste Mission Key or Link here..." 
                                        value={manualKey}
                                        onChange={(e) => setManualKey(e.target.value)}
                                        className="w-full bg-slate-950 border border-slate-800 p-6 rounded-2xl text-indigo-400 text-sm font-mono h-32 outline-none focus:border-indigo-500 transition-all resize-none"
                                    />
                                    <button 
                                        onClick={handleManualJoin}
                                        disabled={!manualKey.trim()}
                                        className={`w-full py-6 rounded-2xl font-orbitron font-bold uppercase text-lg transition-all ${manualKey.trim() ? 'bg-indigo-600 text-white hover:bg-indigo-500 shadow-lg shadow-indigo-600/20' : 'bg-slate-800 text-slate-600 cursor-not-allowed'}`}
                                    >
                                        Establish Connection
                                    </button>
                                </div>
                            </div>
                        )}

                        {view === GameState.SETUP && (
                            <div className="glass-card p-6 md:p-8 rounded-[3rem] space-y-6 animate-fade-in border-t-4 border-indigo-500 relative">
                                <BackButton to={GameState.MODE} />
                                <div className="grid grid-cols-2 gap-4 pt-4">
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-end"><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Players</label><span className="text-indigo-400 font-bold text-xl">{numPlayers}</span></div>
                                        <input type="range" min="3" max="12" value={numPlayers} onChange={e => {
                                            const v = parseInt(e.target.value); setNumPlayers(v);
                                            setPlayerNames(prev => v > prev.length ? [...prev, ...Array(v - prev.length).fill("")] : prev.slice(0, v));
                                        }} className="w-full" />
                                    </div>
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-end"><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Imposters</label><span className="text-red-500 font-bold text-xl">{numImposters}</span></div>
                                        <input type="range" min="1" max={Math.floor(numPlayers / 2) || 1} value={numImposters} onChange={e => setNumImposters(parseInt(e.target.value))} className="w-full accent-red-500" />
                                    </div>
                                </div>

                                <div className="space-y-2">
                                    <div className="flex justify-between items-end"><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Time Limit (m)</label><span className="text-indigo-400 font-bold text-xl">{duration}m</span></div>
                                    <input type="range" min="1" max="15" step="1" value={duration} onChange={e => setDuration(parseInt(e.target.value))} className="w-full" />
                                </div>

                                <div>
                                    <label className="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Target Category</label>
                                    <div className="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                                        {CATEGORIES.map(c => (
                                            <button key={c} onClick={() => setCategory(c)} className={`py-3 px-1 rounded-xl text-[9px] font-black uppercase transition-all border ${category === c ? 'bg-indigo-600/20 border-indigo-500 text-indigo-400' : 'bg-slate-900 border-slate-800 text-slate-600 hover:border-slate-600'}`}>
                                                {c}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <label className="block text-[10px] font-black text-slate-500 uppercase tracking-widest">Agent Manifest</label>
                                    <div className="grid grid-cols-2 gap-3 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                                        {playerNames.map((n, i) => (
                                            <div key={i} className="relative">
                                                <input placeholder={`Agent ${i+1}`} value={n} onChange={e => { const nx = [...playerNames]; nx[i] = e.target.value; setPlayerNames(nx); }} className="w-full bg-slate-950/50 p-4 rounded-xl border border-slate-800 text-xs text-white font-bold focus:border-indigo-500 outline-none pl-10" />
                                                <Icon name="User" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-700" />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <button onClick={startNewGame} className="w-full py-6 bg-indigo-600 rounded-[2rem] text-white font-orbitron font-bold uppercase tracking-widest shadow-lg shadow-indigo-600/30 hover:bg-indigo-500 active:scale-95 transition-all text-lg">Initialize Room</button>
                            </div>
                        )}

                        {view === GameState.SHARE && (
                            <div className="glass-card p-10 rounded-[3rem] text-center space-y-8 animate-fade-in border-t-4 border-indigo-500 relative">
                                <BackButton to={GameState.SETUP} />
                                <div className="space-y-2 pt-4">
                                    <h2 className="text-indigo-400 font-orbitron font-bold text-xl">Room Active</h2>
                                    <div className="bg-slate-950 p-4 rounded-2xl border-2 border-dashed border-indigo-500/50">
                                        <p className="text-4xl font-black tracking-[0.3em] text-white">{roomCode}</p>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <p className="text-slate-400 text-xs leading-relaxed uppercase tracking-widest">Broadcast Mission Parameters</p>
                                    
                                    {showLinkFallback ? (
                                        <div className="space-y-2">
                                            <input 
                                                readOnly 
                                                value={getShareableLink(getEncodedState(gameData, players, roomCode))} 
                                                className="w-full bg-slate-900 border border-indigo-500/50 p-4 rounded-xl text-[10px] text-indigo-400 font-mono"
                                                onClick={(e) => e.target.select()}
                                            />
                                            <p className="text-[10px] text-slate-500 uppercase">Long-press to copy link</p>
                                        </div>
                                    ) : (
                                        <button 
                                            onClick={() => copyToClipboard(getShareableLink(getEncodedState(gameData, players, roomCode)))}
                                            className="w-full py-6 bg-indigo-600 text-white font-orbitron font-bold rounded-2xl flex items-center justify-center gap-3 hover:bg-indigo-500 shadow-xl"
                                        >
                                            <Icon name="Link" className="w-5 h-5" /> Copy Link
                                        </button>
                                    )}

                                    <button onClick={() => setView(GameState.JOIN)} className="w-full py-4 text-indigo-400 font-bold uppercase tracking-widest text-xs">Enter Briefing Room</button>
                                </div>
                            </div>
                        )}

                        {view === GameState.JOIN && (
                            <div className="glass-card p-10 rounded-[3rem] text-center space-y-8 animate-fade-in border-t-4 border-indigo-500 relative">
                                <BackButton to={GameState.MODE} />
                                <div className="space-y-2 pt-6">
                                    <h2 className="text-indigo-400 font-orbitron font-bold text-xl uppercase">Mission Identified</h2>
                                    <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Verification: {roomCode}</p>
                                </div>
                                <div className="space-y-3">
                                    <p className="text-slate-400 text-sm italic">Select your identity to receive assignment.</p>
                                    <div className="grid grid-cols-1 gap-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                        {players.map((p, idx) => (
                                            <button key={p.id} onClick={() => { setCurrentPlayerIdx(idx); setView(GameState.CONFIRM); }} className="w-full p-5 rounded-2xl bg-slate-900/50 border border-slate-800 text-white font-bold uppercase hover:border-indigo-500 transition-all flex justify-between items-center group">
                                                <span className="group-hover:text-indigo-400 transition-colors">{p.name}</span>
                                                <Icon name="ChevronRight" className="w-5 h-5 text-indigo-500 opacity-50 group-hover:opacity-100" />
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === GameState.CONFIRM && (
                            <div className="glass-card p-12 rounded-[4rem] text-center space-y-8 animate-fade-in border-t-4 border-indigo-500 relative">
                                <BackButton to={GameState.JOIN} />
                                <div className="flex flex-col items-center gap-4 pt-6">
                                    <div className="w-24 h-24 bg-indigo-600/20 rounded-full flex items-center justify-center pulse-red">
                                        <Icon name="ShieldCheck" className="w-12 h-12 text-indigo-400" />
                                    </div>
                                    <p className="text-[10px] font-black text-indigo-500 uppercase tracking-[0.4em]">Identity Handshake</p>
                                </div>
                                <div className="space-y-2">
                                    <h2 className="text-slate-500 font-bold uppercase tracking-widest text-sm">Target Agent</h2>
                                    <h3 className="text-5xl font-orbitron font-black text-white uppercase italic">{players[currentPlayerIdx].name}</h3>
                                </div>
                                <button onClick={() => setView(GameState.REVEAL)} className="w-full py-8 bg-indigo-600 text-white rounded-[2.5rem] font-black uppercase text-xl shadow-xl hover:bg-indigo-500 shadow-indigo-600/20">AUTHORIZE ACCESS</button>
                            </div>
                        )}

                        {view === GameState.REVEAL && (
                            <div className="glass-card p-10 rounded-[3rem] text-center space-y-8 animate-fade-in border-t-4 border-red-500/50 relative">
                                <BackButton to={GameState.CONFIRM} onClick={() => setIsSecretVisible(false)} />
                                <div className="space-y-1 pt-6">
                                    <h2 className="text-4xl font-orbitron font-black text-white italic">{players[currentPlayerIdx].name}</h2>
                                    <p className="text-[10px] font-black text-red-500 uppercase tracking-[0.4em]">Active Neural Stream</p>
                                </div>
                                <div className="py-2 h-[280px] flex items-center justify-center">
                                    {!isSecretVisible ? (
                                        <button onClick={() => setIsSecretVisible(true)} className="w-full h-full bg-slate-950/80 border-2 border-dashed border-indigo-500/30 rounded-[3rem] flex flex-col items-center justify-center gap-4 text-indigo-500/50 font-black uppercase tracking-widest hover:border-indigo-500 hover:bg-indigo-900/10">
                                            <Icon name="Fingerprint" className="w-16 h-16 animate-pulse" />
                                            <span>Hold for Imprint</span>
                                        </button>
                                    ) : (
                                        <div className="w-full h-full bg-indigo-950/20 border-2 border-indigo-500/50 rounded-[3rem] animate-fade-in flex flex-col items-center justify-center p-8 relative overflow-hidden">
                                            <div className="absolute inset-0 bg-indigo-500/5 pointer-events-none"></div>
                                            <div className="flex-1 w-full flex items-center justify-center">
                                                <p className={`font-black text-white uppercase text-center leading-tight transition-all duration-500 ${players[currentPlayerIdx].secret.length > 20 ? 'text-2xl' : 'text-4xl'}`}>
                                                    {players[currentPlayerIdx].secret}
                                                </p>
                                            </div>
                                            <div className={`mt-6 px-10 py-4 rounded-full text-sm font-orbitron font-black uppercase tracking-[0.2em] shadow-2xl ${
                                                players[currentPlayerIdx].role === Role.IMPOSTER ? 'bg-red-600 text-white animate-glitch ring-4 ring-red-500/30' : 'bg-green-600 text-white'
                                            }`}>
                                                {players[currentPlayerIdx].role}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <button onClick={handleRevealDone} disabled={!isSecretVisible} className={`w-full py-7 rounded-[2.5rem] font-orbitron font-bold uppercase text-xl transition-all ${isSecretVisible ? 'bg-white text-slate-950 hover:scale-105 active:scale-95' : 'bg-slate-800 text-slate-600 cursor-not-allowed opacity-50'}`}>Synchronized</button>
                            </div>
                        )}

                        {view === GameState.PLAYING && (
                            <div className="space-y-6 animate-fade-in relative pt-12">
                                <BackButton to={GameState.MODE} onClick={() => {
                                    if (confirm("Reset current mission?")) {
                                        safeResetURL();
                                    } else {
                                        setView(GameState.PLAYING);
                                    }
                                }} />
                                <div className="glass-card p-8 rounded-[2.5rem] text-center border-t-2 border-indigo-500">
                                    <div className="flex items-center justify-center gap-6 mb-6">
                                        <Icon name="Timer" className={timeLeft < 30 ? 'text-red-500 animate-pulse' : 'text-indigo-400'} />
                                        <span className={`text-6xl font-orbitron font-black tracking-tighter ${timeLeft < 30 ? 'text-red-500' : 'text-white'}`}>{Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}</span>
                                    </div>
                                    <div className="p-4 bg-slate-950/50 rounded-2xl border border-indigo-500/10 mb-2">
                                        <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">Mission Brief</p>
                                        <p className="text-slate-400 text-xs italic leading-tight">"{gameData.lore}"</p>
                                    </div>
                                    <p className="text-slate-500 text-[10px] font-bold uppercase tracking-widest mt-4">Identify and Purge the Infiltrator.</p>
                                </div>
                                <div className="glass-card p-8 rounded-[3rem] border-t-2 border-red-500/50">
                                    <h3 className="text-red-500 text-[10px] font-black uppercase tracking-[0.4em] mb-6 text-center">Neural Suspension Vote</h3>
                                    <div className="grid grid-cols-1 gap-2">
                                        {players.map(p => (
                                            <button key={p.id} onClick={() => { setVotedPlayer(p); setView(GameState.VOTED_REVEAL); }} className="group w-full p-5 flex justify-between items-center rounded-2xl bg-slate-900/50 border border-slate-800 hover:border-red-500 transition-all hover:bg-red-950/10">
                                                <span className="font-orbitron font-bold uppercase text-slate-400 group-hover:text-red-500 transition-colors">{p.name}</span>
                                                <Icon name="Skull" className="w-5 h-5 text-slate-800 group-hover:text-red-500 transition-colors" />
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === GameState.VOTED_REVEAL && (
                            <div className="glass-card p-12 rounded-[4rem] text-center space-y-12 animate-fade-in flex flex-col items-center relative">
                                <BackButton to={GameState.PLAYING} />
                                <div className="space-y-4 pt-6">
                                    <h2 className="text-slate-500 font-bold uppercase tracking-widest text-sm">System De-Synchronization</h2>
                                    <h3 className="text-5xl font-orbitron font-black text-white italic animate-glitch">{votedPlayer.name}</h3>
                                </div>
                                <div className="w-48 h-48 rounded-full border-4 border-dashed border-indigo-500 flex items-center justify-center relative">
                                    <div className="absolute inset-2 bg-indigo-500/10 rounded-full animate-pulse"></div>
                                    <Icon name="Activity" className="w-20 h-20 text-indigo-400 animate-pulse" />
                                </div>
                                <div className="space-y-4 w-full">
                                    <p className="text-slate-400 text-sm leading-relaxed uppercase tracking-widest font-bold text-[10px]">Purge Protocol Authorized</p>
                                    <button onClick={() => { setWinner(votedPlayer.role === Role.IMPOSTER ? Role.CIVILIAN : Role.IMPOSTER); setView(GameState.WINNER); }} className="w-full py-7 bg-red-600 text-white font-orbitron font-bold rounded-[2.5rem] shadow-xl hover:bg-red-500 uppercase tracking-widest shadow-red-600/20">Finalize Purge</button>
                                </div>
                            </div>
                        )}

                        {view === GameState.WINNER && (
                            <div className="glass-card p-10 rounded-[4rem] text-center space-y-10 animate-fade-in border-t-4 border-indigo-500 relative">
                                <BackButton to={GameState.MODE} onClick={() => {
                                    safeResetURL();
                                    setIsOnline(false);
                                    setManualKey("");
                                }} />
                                <div className="relative pt-6">
                                    <Icon name={winner === Role.CIVILIAN ? "Trophy" : "Radiation"} className={`w-24 h-24 mx-auto mb-4 ${winner === Role.CIVILIAN ? 'text-green-500 drop-shadow-[0_0_15px_rgba(34,197,94,0.5)]' : 'text-red-500 drop-shadow-[0_0_15px_rgba(239,68,68,0.5)]'}`} />
                                    <h2 className={`text-6xl font-orbitron font-black italic tracking-tighter ${winner === Role.CIVILIAN ? 'text-green-400' : 'text-red-400'}`}>{winner === Role.CIVILIAN ? 'VICTORY' : 'FAILURE'}</h2>
                                    <p className="text-slate-500 text-[10px] font-bold uppercase tracking-[0.4em] mt-2">{winner === Role.CIVILIAN ? 'Neural Grid Secured' : 'Critical System Compromise'}</p>
                                </div>
                                
                                <div className="space-y-3">
                                    <div className="bg-slate-950 p-6 rounded-3xl border border-indigo-500/10 flex flex-col gap-1">
                                        <p className="text-[9px] text-slate-600 font-black uppercase tracking-widest">Base Code</p>
                                        <p className="text-indigo-400 font-orbitron font-black uppercase text-2xl">{gameData.word}</p>
                                    </div>
                                    <div className="bg-slate-950 p-6 rounded-3xl border border-indigo-500/10 flex flex-col gap-1 text-left">
                                        <p className="text-[9px] text-slate-600 font-black uppercase tracking-widest">Imposter Frequency</p>
                                        <p className="text-slate-300 font-bold text-sm leading-tight italic">"{gameData.hint}"</p>
                                    </div>
                                </div>

                                <div className="space-y-4 pt-6 border-t border-slate-800">
                                    <button onClick={() => { 
                                        setView(GameState.MODE); 
                                        safeResetURL();
                                        setIsOnline(false);
                                        setManualKey("");
                                    }} className="w-full py-6 bg-indigo-600 text-white font-orbitron font-bold rounded-[2.5rem] shadow-lg shadow-indigo-600/20 hover:bg-indigo-500 active:scale-95 transition-all uppercase tracking-widest text-lg">Re-Initialize</button>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="mt-auto py-8 text-slate-700 text-[9px] font-black uppercase tracking-[1em] animate-fade-in text-center opacity-40">
                         System Synchronized . End of Stream
                    </footer>
                </div>
            );
        };

        const rootEl = document.getElementById('root');
        if (rootEl) createRoot(rootEl).render(<App />);
    </script>
</body>
</html>
